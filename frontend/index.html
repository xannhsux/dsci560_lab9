<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DSCI-560 PDF Chatbot</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #111827;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
    }

    .sidebar {
      width: 300px;
      padding: 24px;
      background: rgba(17, 24, 39, 0.92);
      border-right: 1px solid rgba(148, 163, 184, 0.2);
      box-sizing: border-box;
    }

    .sidebar h1 {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }

    .sidebar p {
      margin: 0 0 16px;
      color: #94a3b8;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .sidebar label {
      display: block;
      margin: 18px 0 6px;
      font-weight: 600;
    }

    .sidebar input[type="text"],
    .sidebar input[type="url"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.7);
      color: inherit;
      box-sizing: border-box;
    }

    .sidebar input[type="file"] {
      width: 100%;
      margin-top: 8px;
    }

    .sidebar button {
      margin-top: 16px;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .sidebar button:disabled {
      background: rgba(37, 99, 235, 0.4);
      cursor: not-allowed;
    }

    .sidebar button:hover:not(:disabled) {
      background: #1d4ed8;
    }

    .status {
      margin-top: 12px;
      font-size: 0.9rem;
      color: #fbbf24;
      min-height: 1.4rem;
    }

    .status.success {
      color: #34d399;
    }

    .status.error {
      color: #f87171;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 24px;
      box-sizing: border-box;
    }

    .chat-window {
      flex: 1;
      overflow-y: auto;
      background: rgba(15, 23, 42, 0.55);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .message-icon {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      color: white;
    }

    .message.user .message-icon {
      background: #6366f1;
    }

    .message.bot .message-icon {
      background: #facc15;
      color: #111827;
      font-weight: 700;
    }

    .message-content {
      max-width: 70ch;
      padding: 14px 18px;
      background: rgba(30, 41, 59, 0.88);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .message.user .message-content {
      background: rgba(79, 70, 229, 0.45);
    }

    /* Sources CSS removed - not displaying sources */

    .input-bar {
      margin-top: 18px;
      display: flex;
      gap: 12px;
    }

    .input-bar textarea {
      flex: 1;
      resize: none;
      min-height: 54px;
      max-height: 120px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
      color: inherit;
      font-size: 1rem;
      line-height: 1.4;
      box-sizing: border-box;
    }

    .input-bar button {
      min-width: 120px;
      border: none;
      border-radius: 10px;
      background: #22c55e;
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .input-bar button:hover:not(:disabled) {
      background: #16a34a;
      transform: translateY(-1px);
    }

    .input-bar button:disabled {
      background: rgba(34, 197, 94, 0.4);
      cursor: not-allowed;
    }

    .chat-helper {
      margin-bottom: 12px;
      color: #94a3b8;
      font-size: 0.95rem;
    }

    @media (max-width: 900px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <h1>PDF Knowledge Chatbot</h1>
    <p>Upload one or more PDFs, let the backend extract and embed the content, and ask questions grounded in those documents.</p>

    <label for="apiBase">Backend URL</label>
    <input id="apiBase" type="url" placeholder="http://localhost:8000" />

    <label for="pdfInput">Upload PDFs</label>
    <input id="pdfInput" type="file" accept="application/pdf" multiple />
    <button id="analyzeBtn">Analyze PDFs</button>
    <div class="status" id="statusArea"></div>
  </aside>

  <main class="main">
    <div class="chat-helper">Ask questions after the PDFs are embedded. Type "exit" to reset the conversation locally.</div>
    <section class="chat-window" id="chatWindow">
      <div class="message bot">
        <div class="message-icon">B</div>
        <div class="message-content">
          Hi! Upload PDFs and press "Analyze PDFs" to prepare the knowledge base. Once ready, ask anything about the documents.
        </div>
      </div>
    </section>

    <form class="input-bar" id="chatForm">
      <textarea id="chatInput" placeholder="Ask a question about your PDFs..."></textarea>
      <button type="submit" id="sendBtn">Send</button>
    </form>
  </main>

  <script>
    (function () {
      const apiInput = document.getElementById("apiBase");
      const pdfInput = document.getElementById("pdfInput");
      const analyzeBtn = document.getElementById("analyzeBtn");
      const statusArea = document.getElementById("statusArea");
      const chatWindow = document.getElementById("chatWindow");
      const chatForm = document.getElementById("chatForm");
      const chatInput = document.getElementById("chatInput");
      const sendBtn = document.getElementById("sendBtn");

      let chatHistory = [];

      const savedBase = localStorage.getItem("pdfChatbot.apiBase") || "http://localhost:8000";
      apiInput.value = savedBase;

      function getApiBase() {
        const url = apiInput.value.trim() || "http://localhost:8000";
        localStorage.setItem("pdfChatbot.apiBase", url);
        return url.replace(/\/$/, "");
      }

      function setStatus(message, mode = "") {
        statusArea.textContent = message;
        statusArea.className = "status" + (mode ? " " + mode : "");
      }

      function createMessageElement(role, text, sources = []) {
        const container = document.createElement("div");
        container.className = "message " + role;

        const icon = document.createElement("div");
        icon.className = "message-icon";
        icon.textContent = role === "user" ? "U" : "B";

        const content = document.createElement("div");
        content.className = "message-content";
        content.textContent = text;

        // Sources display removed - keeping clean answer only

        container.appendChild(icon);
        container.appendChild(content);
        return container;
      }

      function appendMessage(role, text, sources) {
        const element = createMessageElement(role, text, sources);
        chatWindow.appendChild(element);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      async function ingestPdfs(event) {
        event.preventDefault();
        const files = pdfInput.files;
        if (!files || files.length === 0) {
          setStatus("Please choose at least one PDF.", "error");
          return;
        }

        const formData = new FormData();
        Array.from(files).forEach((file) => formData.append("files", file));

        analyzeBtn.disabled = true;
        setStatus("Uploading and processing PDFs...", "");

        try {
          const response = await fetch(getApiBase() + "/ingest", {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || response.statusText);
          }

          const payload = await response.json();
          const msg = `Vector store ready: ${payload.ingested} new chunks (${payload.documents} total).`;
          setStatus(msg, "success");
          appendMessage("bot", "Ingestion complete. Ask away!");
        } catch (err) {
          console.error(err);
          setStatus(`Failed to ingest PDFs: ${err.message}`, "error");
        } finally {
          analyzeBtn.disabled = false;
        }
      }

      async function askQuestion(event) {
        event.preventDefault();
        const question = chatInput.value.trim();
        if (!question) {
          return;
        }

        if (question.toLowerCase() === "exit") {
          chatHistory = [];
          chatWindow.innerHTML = "";
          appendMessage("bot", "Conversation cleared locally. You can start a new chat.");
          chatInput.value = "";
          return;
        }

        appendMessage("user", question);
        chatInput.value = "";
        sendBtn.disabled = true;

        try {
          const response = await fetch(getApiBase() + "/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ question })
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || response.statusText);
          }

          const payload = await response.json();
          appendMessage("bot", payload.answer || "(No answer returned.)", payload.sources || []);
        } catch (err) {
          console.error(err);
          appendMessage("bot", "Error: " + err.message);
        } finally {
          sendBtn.disabled = false;
          chatInput.focus();
        }
      }

      analyzeBtn.addEventListener("click", ingestPdfs);
      chatForm.addEventListener("submit", askQuestion);
      chatInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          chatForm.dispatchEvent(new Event("submit", { cancelable: true }));
        }
      });
    })();
  </script>
</body>
</html>

